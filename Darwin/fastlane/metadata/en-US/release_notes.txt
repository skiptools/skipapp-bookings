Numerous bug fixes and performance improvements.

